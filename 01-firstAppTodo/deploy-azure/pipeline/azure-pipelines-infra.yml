parameters:
- name: environmentName
  type: string
  default: dev1
- name: subnetAddressPrefix
  type: string
  default: 1
- name: deploymentLocation
  type: string
  default: westeurope
- name: deploymentLocationSuffix
  type: string
  default: we
- name: serviceConnectionName
  type: string
  default: 'Azure Personal'

trigger:
  branches:
    include:
    - main
  # paths:
  #   include:
  #   - 01-firstAppTodo/infra-as-code.bicep

variables:
  vmImageName: 'ubuntu-latest'
  buildConfiguration: 'Release'
  dotNetFramework: 'net6.0'
  dotNetVersion: '6.0.x'
  azureServiceConnection: ${{parameters.serviceConnectionName}}
  resourceGroupName: 'rg-firstapp-${{parameters.environmentName}}-${{parameters.deploymentLocationSuffix}}'
  location: ${{parameters.deploymentLocation}}
  templateFile: './01-firstAppTodo/deploy-azure/infra-as-code.bicep'
  # Ideally this should be retrieve as output, this is to be implemented
  # from docs, it seems we can use deploymentOutputs parameter from AzureResourceManagerTemplateDeployment
  azureAppServiceName: 'webapptodofirstapp${{parameters.environmentName}}${{parameters.deploymentLocationSuffix}}'

# - stage: Validate_Bicep_${{parameters.environmentName}}
#     displayName: Validate Bicep file for ${{parameters.environmentName}} environment
#     jobs:
#     - job: DeployBicepAzure
#       displayName: Deploy Infra Bicep to Azure

#       pool:
#         vmImage: $(vmImageName)

#       steps:
stages:
- stage: Deploy_Infra_to_${{parameters.environmentName}}
  displayName: Deploy Infra to (${{parameters.environmentName}} environment)
  jobs:
  - job: DeployBicepAzure
    displayName: Deploy Infra Bicep to Azure

    pool:
      vmImage: $(vmImageName)

    steps:
    - task: AzureCLI@2
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: 'az group create --name $(resourceGroupName) --location $(location)'

    - task: AzureResourceManagerTemplateDeployment@3
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: '$(azureServiceConnection)'
        action: 'Create Or Update Resource Group'
        resourceGroupName: '$(resourceGroupName)'
        location: '$(location)'
        templateLocation: 'Linked artifact'
        csmFile: '$(templateFile)'
        overrideParameters: ' -environment ${{parameters.environmentName}} -subnetAddressPrefix ${{parameters.subnetAddressPrefix}} -location $(location) -location_suffix ${{parameters.deploymentLocationSuffix}}'
        deploymentMode: 'Complete'
        deploymentName: 'DeployPipelineTemplate'

- stage: Deploy_WebApp_to_${{parameters.environmentName}}
  displayName: Deploy Web App to ${{parameters.environmentName}} environment
  jobs:
  - job: DeployWebApp
    displayName: Deploy Web App

    pool:
      vmImage: $(vmImageName)

    # Build and deploy the app for .NET 6 framework
    steps:
    - task: UseDotNet@2
      inputs:
        version: $(dotNetVersion)
        includePreviewVersions: true
    - script: dotnet build --configuration $(buildConfiguration)
      displayName: 'Build .NET 6 Application'
      workingDirectory: '01-firstAppTodo/'

    - task: DotNetCoreCLI@2
      inputs:
        command: 'publish'
        publishWebProjects: true

    #Publish it to the Azure App Service
    - task: AzureWebApp@1
      # This is here because theres an issue with this task: the resource cannot be found
      retryCountOnTaskFailure: 10
      inputs:
        appType: webApp
        azureSubscription: $(azureServiceConnection) #this is the name of the SPN
        appName: $(azureAppServiceName) #App Service's unique name
        package: $(System.DefaultWorkingDirectory)/01-firstAppTodo/**/*.zip